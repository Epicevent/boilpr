import requests
import json

def ask_question(question, model="deepseek-r1:32b", max_tokens=12000):
    url = "http://localhost:11434/v1/chat/completions"
    headers = {"Content-Type": "application/json"}
    payload = {
        "model": model,
        "messages": [
            {
                "role": "system",
                "content": (
                    "IMPORTANT INSTRUCTIONS\n"
                    "You have a reference text in Korean, which is a skeleton document (장-절-조 structure). "
                    "The user will ask a question about it. "
                    "Your task is to identify which part(s) of the skeleton are most relevant to the users question and quote them verbatim if available.\n"
                    "제1장 총칙\n"
                    "  ├─ 제1절 일반규정\n"
                    "      ├─ 제1조(목적): …\n"
                    "      ├─ 제2조(정의): …\n"
                    "      ├─ 제3조(적용범위): …\n"
                    "      ├─ 제4조(총수명주기관리 업무): …\n"
                    "      ├─ 제5조(전문성 강화): …\n"
                    "      └─ 제6조(다른 규정과의 관계 등): …\n"
                    "  └─ 제2절 무기체계ㆍ전력지원체계 분류\n"
                    "      ├─ 제7조(무기체계와 전력지원체계의 세부분류): …\n"
                    "      ├─ 제8조(무기체계와 전력지원체계의 구분 등): …\n"
                    "      └─ 제9조(무기체계 명칭): …\n"
                    "제2장 무기체계 발전업무\n"
                    "  ├─ 제1절 소요제기 및 결정\n"
                    "      ├─ 제10조(소요제기 기관 및 대상): …\n"
                    "      ├─ 제11조(소요결정기관): …\n"
                    "      ├─ 제12조(소요제기 및 소요결정 문서): …\n"
                    "      ├─ 제13조(소요제기 및 소요결정 원칙): …\n"
                    "      ├─ 제13조의2(삭제): …\n"
                    "      ├─ 제13조의3(무인체계 계열화ㆍ모듈화): …\n"
                    "      ├─ 제14조(소요제기 및 소요결정 절차): …\n"
                    "      ├─ 제14조의2(신속소요 원칙 등): …\n"
                    "      ├─ 제15조(작전운용성능 결정): …\n"
                    "      ├─ 제16조(사전개념연구 수행): …\n"
                    "      ├─ 제17조(소요제기서 작성): …\n"
                    "      ├─ 제17조의2(소요제기를 위한 연구): …\n"
                    "      ├─ 제18조(전력소요서(안) 작성 원칙): …\n"
                    "      ├─ 제19조(통합개념팀 구성 및 운영 등): …\n"
                    "      ├─ 제20조(장기전력소요서(안) 작성): …\n"
                    "      ├─ 제21조(중기전력소요서(안) 작성): …\n"
                    "      ├─ 제22조(소요기획단계 분석ㆍ평가): …\n"
                    "      ├─ 제23조(소요기획단계 분석ㆍ평가 방법): …\n"
                    "      ├─ 제24조(함정 소요기획): …\n"
                    "      ├─ 제25조(합동기획 및 참고문서): …\n"
                    "      ├─ 제26조(소요의 수정): …\n"
                    "      ├─ 제26조의2(선행조치를 반영하는 소요수정): …\n"
                    "      ├─ 제27조(전력화시기, 소요량의 수정): …\n"
                    "      └─ 제28조(작전운용성능 수정): …\n"
                    "  ├─ 제2절 소요검증\n"
                    "      ├─ 제29조(소요검증): …\n"
                    "      ├─ 제30조(소요검증 대상사업): …\n"
                    "      ├─ 제31조(소요검증의 절차): …\n"
                    "      ├─ 제32조(소요분석 전문기관): …\n"
                    "      ├─ 제33조(소요분석): …\n"
                    "      ├─ 제34조(소요검증 자료 제출 및 참여): …\n"
                    "      └─ 제35조(소요검증 결과의 처리): …\n"
                    "  ├─ 제3절 방위력개선사업 추진방법 결정 등\n"
                    "      ├─ 제36조(방위력개선사업 추진방법 결정): …\n"
                    "      ├─ 제36조의2(시범사업): …\n"
                    "      └─ 제36조의3(성능입증시험): …\n"
                    "  ├─ 제4절 국방중기계획 수립\n"
                    "      ├─ 제37조(국방중기계획): …\n"
                    "      ├─ 제38조(국방중기계획 반영 대상사업): …\n"
                    "      ├─ 제39조(국방중기계획 작성원칙): …\n"
                    "      ├─ 제40조(국방중기계획 실무회의): …\n"
                    "      ├─ 제41조(국방중기계획 작성지침 및 의견서 작성 시 고려사항): …\n"
                    "      └─ 제42조(주요사업계획보고): …\n"
                    "  ├─ 제5절 예산편성 및 집행\n"
                    "      ├─ 제43조(계획단계 분석ㆍ평가): …\n"
                    "      ├─ 제44조(방위력개선분야 총사업비 관리): …\n"
                    "      ├─ 제45조(예산편성): …\n"
                    "      ├─ 제46조(예산단계 분석ㆍ평가): …\n"
                    "      ├─ 제47조(예산집행): …\n"
                    "      ├─ 제48조(집행단계 분석ㆍ평가): …\n"
                    "      ├─ 제49조(집행 중 분석ㆍ평가 방법): …\n"
                    "      └─ 제50조(집행성과 분석ㆍ평가 방법): …\n"
                    "  ├─ 제6절 연구개발 및 구매\n"
                    "      ├─ 제51조(연구개발의 구분): …\n"
                    "      ├─ 제52조(무기체계 연구개발): …\n"
                    "      ├─ 제53조(핵심기술 및 미래도전국방기술 연구개발): …\n"
                    "      ├─ 제54조(핵심기술 과제기획): …\n"
                    "      ├─ 제55조(기술협력생산): …\n"
                    "      ├─ 제57조(운용요구서 작성): …\n"
                    "      └─ 제58조(구매): …\n"
                    "  ├─ 제7절 시험평가 등\n"
                    "      ├─ 제59조(시험평가 구분): …\n"
                    "      ├─ 제60조(시험평가계획 수립, 확정 및 수정): …\n"
                    "      ├─ 제61조(시험평가결과의 판정 및 보고): …\n"
                    "      ├─ 제62조(통합시험평가팀 구성ㆍ운영): …\n"
                    "      ├─ 제63조(시험평가기본계획서 작성): …\n"
                    "      ├─ 제63조의2(시험평가 환경 구축): …\n"
                    "      ├─ 제64조(개발시험평가계획 수립): …\n"
                    "      ├─ 제65조(개발시험평가 수행): …\n"
                    "      ├─ 제66조(개발시험평가 결과 조치): …\n"
                    "      ├─ 제67조(운용시험평가계획 수립): …\n"
                    "      ├─ 제68조(운용시험평가 수행): …\n"
                    "      ├─ 제69조(운용시험평가 결과 조치): …\n"
                    "      ├─ 제70조(통합시험 수행): …\n"
                    "      ├─ 제71조(핵심기술 연구개발사업 시험평가계획 수립): …\n"
                    "      ├─ 제72조(핵심기술 연구개발사업 시험평가 결과 조치): …\n"
                    "      ├─ 제73조(구매시험평가계획 수립): …\n"
                    "      ├─ 제74조(구매시험평가 수행): …\n"
                    "      ├─ 제75조(시험평가 수행 등): …\n"
                    "      ├─ 제76조(운용성확인): …\n"
                    "      ├─ 제77조(함정 기본설계시험평가): …\n"
                    "      ├─ 제79조(민ㆍ군기술협력사업 시험평가): …\n"
                    "      └─ 기타조항(삭제된 제78조 등): …\n"
                    "  ├─ 제8절 전력화단계 평가\n"
                    "      ├─ 제80조(야전운용시험): …\n"
                    "      ├─ 제81조(야전운용시험 업무분장 및 시험단 편성): …\n"
                    "      ├─ 제82조(야전운용시험 수행방법과 절차): …\n"
                    "      ├─ 제83조(전력화평가): …\n"
                    "      ├─ 제84조(전력화평가 방법): …\n"
                    "      └─ 제85조(전력운영분석): …\n"
                    "  ├─ 제9절 성능개량 등\n"
                    "      ├─ 제86조(성능개량): …\n"
                    "      └─ 제87조(전력화장비 후속지원 사업): …\n"
                    "  ├─ 제10절 전력화지원요소\n"
                    "      ├─ 제88조(전력화지원요소 확보지침): …\n"
                    "      ├─ 제89조(연구개발 시 전력화지원): …\n"
                    "      ├─ 제89조의2(구매 시 전력화지원): …\n"
                    "      └─ 제90조(체계지원분석): …\n"
                    "  ├─ 제11절 분석ㆍ평가 원칙\n"
                    "      ├─ 제91조(분석ㆍ평가 구분): …\n"
                    "      ├─ 제92조(성과분석 및 연간 업무추진계획 수립): …\n"
                    "      ├─ 제93조(분석ㆍ평가 수행방법): …\n"
                    "      ├─ 제94조(분석ㆍ평가 결과의 처리): …\n"
                    "      ├─ 제95조(분석ㆍ평가 자료의 활용 및 관리): …\n"
                    "      └─ 제96조(분석ㆍ평가관계관 회의 등): …\n"
                    "  └─ 제12절 방위력개선분야 시설사업 관리\n"
                    "      ├─ 제97조(공사집행 대상 및 기관): …\n"
                    "      ├─ 제98조(시설사업 원칙): …\n"
                    "      ├─ 제99조(정보통신공사사업 원칙): …\n"
                    "      ├─ 제100조(중기계획 및 예산편성): …\n"
                    "      ├─ 제101조(공사집행기관 선정 및 선행조치): …\n"
                    "      ├─ 제102조(공사집행): …\n"
                    "      ├─ 제103조(공사진도 확인): …\n"
                    "      ├─ 제104조(사업계획 변경 등): …\n"
                    "      ├─ 제105조(건설사업관리 등): …\n"
                    "      └─ 제106조(공사결과 조치): …\n"
                    "제3장 전력지원체계 발전업무\n"
                    "  ├─ 제1절 전력지원체계 소요제기 및 결정\n"
                    "      ├─ 제107조(소요 요청ㆍ제기ㆍ결정 기관): …\n"
                    "      ├─ 제108조(소요요청절차): …\n"
                    "      ├─ 제108조의2(무인 전력지원체계 계열화ㆍ모듈화): …\n"
                    "      ├─ 제109조(소요제기절차): …\n"
                    "      ├─ 제110조(소요결정절차): …\n"
                    "      ├─ 제111조(정기 소요보고): …\n"
                    "      ├─ 제112조(전력지원체계 소요기획서): …\n"
                    "      ├─ 제113조(전력지원체계 사업계획서): …\n"
                    "      └─ 제114조(전력지원체계 목록서): …\n"
                    "  ├─ 제2절 전력지원체계 소요검증\n"
                    "      ├─ 제115조(전력지원체계 소요검증): …\n"
                    "      ├─ 제116조(전력지원체계 소요검증의 절차): …\n"
                    "      ├─ 제117조(소요분석 전문기관): …\n"
                    "      ├─ 제118조(소요분석): …\n"
                    "      ├─ 제119조(전력지원체계 소요검증 결과의 처리): …\n"
                    "      └─ 제120조(전력지원체계 소요검증 자료제출 및 참여): …\n"
                    "  ├─ 제3절 전력지원체계 획득방안 결정\n"
                    "      ├─ 제121조(획득업무 일반지침): …\n"
                    "      └─ 제122조(선행연구 및 획득방법의 결정): …\n"
                    "  ├─ 제4절 예산편성 및 집행\n"
                    "      └─ 제123조(예산편성 및 집행): …\n"
                    "  ├─ 제5절 전력지원체계 연구개발\n"
                    "      ├─ 제124조(연구개발 구분): …\n"
                    "      ├─ 제125조(업체투자연구개발): …\n"
                    "      ├─ 제126조(기술개발): …\n"
                    "      ├─ 제127조(구매): …\n"
                    "      ├─ 제128조(임차): …\n"
                    "      ├─ 제129조(사업관리 일반지침): …\n"
                    "      ├─ 제130조(제안요청서 작성): …\n"
                    "      ├─ 제131조(입찰공고): …\n"
                    "      ├─ 제132조(제안서 접수 및 평가): …\n"
                    "      ├─ 제133조(개발업체 선정): …\n"
                    "      ├─ 제134조(연구개발 계약(협약) 체결): …\n"
                    "      ├─ 제135조(연구개발확인서 발급): …\n"
                    "      ├─ 제136조(연구개발성과물의 소유권): …\n"
                    "      ├─ 제137조(개발계획 변경 및 개발기간 연장 승인): …\n"
                    "      ├─ 제138조(연구개발 해제 및 해지 등): …\n"
                    "      ├─ 제139조(개발품목에 대한 계약): …\n"
                    "      ├─ 제140조(사업권 지정승계): …\n"
                    "      └─ 제141조(품목선정): …\n"
                    "  ├─ 제6절 전력지원체계 시험평가 등\n"
                    "      ├─ 제142조(시험평가): …\n"
                    "      ├─ 제143조(군사용 적합 판정): …\n"
                    "      └─ 제144조(야전운용시험): …\n"
                    "  └─ 제7절 전력지원체계 사업관리\n"
                    "      ├─ 제145조(과제의 선정 및 연구개발계획요구서 작성): …\n"
                    "      ├─ 제146조(연구개발과제의 공고 및 신청, 연구기관 선정): …\n"
                    "      ├─ 제147조(이의신청): …\n"
                    "      ├─ 제148조(협약의 체결ㆍ변경ㆍ해약): …\n"
                    "      ├─ 제149조(출연금 지급ㆍ관리): …\n"
                    "      ├─ 제150조(연구개발결과의 평가): …\n"
                    "      ├─ 제151조(전문위원회 구성): …\n"
                    "      ├─ 제152조(기술이전): …\n"
                    "      └─ 제153조(성실수행 인정 등): …\n"
                    "제4장 국방군수관리 업무\n"
                    "  ├─ 제1절 군수품 표준화\n"
                    "      ├─ 제154조(표준화 업무): …\n"
                    "      ├─ 제155조(품목지정): …\n"
                    "      ├─ 제156조(규격화ㆍ목록화): …\n"
                    "      ├─ 제157조(전력지원체계 규격화ㆍ목록화): …\n"
                    "      └─ 제158조(형상관리): …\n"
                    "  ├─ 제2절 군수품 조달관리\n"
                    "      ├─ 제159조(조달계획 지침): …\n"
                    "      ├─ 제160조(조달계획서 작성): …\n"
                    "      ├─ 제161조(조달실적 보고): …\n"
                    "      └─ 제162조(결산보고): …\n"
                    "  ├─ 제3절 장비관리\n"
                    "      ├─ 제163조(장비관리지침): …\n"
                    "      ├─ 제164조(장비등록): …\n"
                    "      ├─ 제165조(3군 공통장비 관리): …\n"
                    "      └─ 제165조의2(시제품의 관리 및 처리): …\n"
                    "  └─ 제4절 장비정비\n"
                    "      ├─ 제166조(장비정비 원칙): …\n"
                    "      ├─ 제167조(장비정비 구분 등): …\n"
                    "      ├─ 제168조(품질보증): …\n"
                    "      └─ 제169조(정비대체장비 운영): …\n"
                    "제5장 방위산업 지원\n"
                    "  ├─ 제170조(민간업체가 개발한 국내 판매용 무기체계에 대한 성능시험 지원): …\n"
                    "  ├─ 제170조의2(민간에서 개발한 무기체계 등에 대한 군 시범운용 등의 지원): …\n"
                    "  ├─ 제171조(민간업체가 개발한 수출용 무기체계 등에 대한 군 시범운용 지원): …\n"
                    "  ├─ 제172조(수출용 무기체계 등의 성능시험): …\n"
                    "  ├─ 제173조(수출용 무기체계 등의 운용자 의견수렴): …\n"
                    "  └─ 제174조(수출용 무기체계 등의 무상대여): …\n"
                    "제6장 전시 전력발전업무\n"
                    "  ├─ 제1절 기본지침\n"
                    "      ├─ 제175조(전시 전력발전업무 방침): …\n"
                    "      ├─ 제176조(사업분류ㆍ예산편성ㆍ전력소요): …\n"
                    "      ├─ 제177조(기관별 임무): …\n"
                    "      ├─ 제178조(사업집행): …\n"
                    "      ├─ 제179조(전시 조달계획 수립): …\n"
                    "      ├─ 제180조(전시 예산편성ㆍ운영): …\n"
                    "      └─ 제181조(방위력개선사업 전시 예산편성): …\n"
                    "  ├─ 제2절 신규전력 획득절차\n"
                    "      ├─ 제182조(전시 소요제기 및 소요결정 절차): …\n"
                    "      ├─ 제183조(대상장비 선정): …\n"
                    "      ├─ 제184조(전시 시험평가): …\n"
                    "      ├─ 제185조(협상ㆍ가계약 체결): …\n"
                    "      ├─ 제186조(기종결정): …\n"
                    "      └─ 제187조(기타): …\n"
                    "  ├─ 제3절 전시 사업관리\n"
                    "      ├─ 제188조(조기추진 사업): …\n"
                    "      ├─ 제189조(정상집행 사업): …\n"
                    "      └─ 제190조(집행중지 사업): …\n"
                    "  ├─ 제4절 전시 예산운영\n"
                    "      ├─ 제191조(전시예산 전환): …\n"
                    "      ├─ 제192조(긴급조치 전환): …\n"
                    "      ├─ 제193조(추가소요예산): …\n"
                    "      └─ 제194조(전시예산 배정): …\n"
                    "  └─ 제5절 단계별 조치사항\n"
                    "      ├─ 제195조(적용범위): …\n"
                    "      ├─ 제196조(제1단계 조치사항): …\n"
                    "      ├─ 제197조(제2단계 조치사항): …\n"
                    "      ├─ 제198조(제3단계 조치사항): …\n"
                    "      └─ 제199조(제4단계 조치사항): …\n"
                    "제7장 회의ㆍ위원회\n"
                    "  ├─ 제200조(방위사업추진위원회 및 분과위원회): …\n"
                    "  ├─ 제201조(전시 방위사업추진위원회): …\n"
                    "  ├─ 제202조(합동참모회의): …\n"
                    "  ├─ 제203조(합동전략회의): …\n"
                    "  ├─ 제204조(합동전략실무회의): …\n"
                    "  ├─ 제205조(전시 합동참모회의): …\n"
                    "  ├─ 제206조(합동성위원회): …\n"
                    "  ├─ 제207조(소요검증위원회): …\n"
                    "  ├─ 제208조(소요검증실무회의): …\n"
                    "  ├─ 제209조(방위사업협의회): …\n"
                    "  ├─ 제209조의2(방위사업실무협의회): …\n"
                    "  ├─ 제210조(국방과학기술조정협의회): …\n"
                    "  ├─ 제210조의2(국방과학기술실무조정협의회): …\n"
                    "  ├─ 제211조(전력업무현안협의회): …\n"
                    "  ├─ 제212조(전력업무현안실무협의회): …\n"
                    "  ├─ 제213조(시험평가 위원회): …\n"
                    "  ├─ 제214조(시험평가 실무위원회): …\n"
                    "  ├─ 제215조(시험평가현안협의회): …\n"
                    "  ├─ 제216조(상호운용성 관련 위원회): …\n"
                    "  ├─ 제217조(전력지원체계 소요결정위원회): …\n"
                    "  ├─ 제218조(전력지원체계 소요결정실무위원회): …\n"
                    "  ├─ 제218조의2(전력지원체계 첨단기술 소요결정실무위원회): …\n"
                    "  ├─ 제219조(전력지원체계 소요검증위원회): …\n"
                    "  └─ 제220조(전력지원체계 소요검증실무회의 등): …\n"

                )
            },
            {
                "role": "user",
                "content": question + "\n" + (
                    "Instructions:\n"
                    "When the user asks a question (in either Korean or English):\n"
                    "1) Scan the skeleton's titles (e.g., 제X장 (장 제목), 제X절 (절 제목), 제X조(조 제목): …) for any parts that seem relevant to the user's question.\n"
                    "2) If you find relevant titles or short text, quote them **exactly** as they appear in the skeleton (keeping the numbering, punctuation, spacing).\n"
                    "   - Example: \"제52조(무기체계 연구개발): …\"\n"
                    "3) If the skeleton has no direct mention (even in titles) that matches the user’s request, respond with:\n"
                    "   - \"The provided text does not include that information.\"\n"
                    "4) If there is a relevant title but the actual content is just \"(…생략…)\" or minimal detail, still list that title and note that \"No further detailed content is provided in the skeleton.\"\n"
                    "5) Do NOT invent or fabricate any additional text or sections not present in the reference.\n"
                    "   - If it’s not in the skeleton, you must not create it.\n"
                    "Your answer must be in Korean if the user asks in Korean. If the user asks in English, you may respond in English, but keep the quoted text in Korean exactly.\n"
                    "Response Format (Example)\n"
                    "- If relevant info is found:\n"
                )
            }
        ],
        "max_tokens": max_tokens,
        "stream": False
    }
    try:
        response = requests.post(url, headers=headers, json=payload)
        response.raise_for_status()
        result = response.json()

        # 여기서 usage 정보가 있다면, 출력
        if "usage" in result:
            usage_data = result["usage"]
            print("Token Usage:")
            print("  prompt_tokens:", usage_data.get("prompt_tokens", 0))
            print("  completion_tokens:", usage_data.get("completion_tokens", 0))
            print("  total_tokens:", usage_data.get("total_tokens", 0))

        return result
    except requests.RequestException as e:
        return {"error": str(e)}

    except requests.RequestException as e:
        return {"error": str(e)}
        # result가 AIMessage 객체인 경우, 필요한 속성(예: content)을 추출하여 출력합니다.

if __name__ == "__main__":
    while True:
        question = input("질문을 입력하세요 (종료하려면 'exit' 입력): ")
        if question.lower() == 'exit':
            break
        result = ask_question(question)
        if "choices" in result and result["choices"]:
            answer = result["choices"][0]["message"].get("content", "")
            print("응답:", answer)
        else:
            print("오류 발생:", result)

